name: Daily Profile Automation

on:
  workflow_dispatch:
  schedule:
    # 01:00 Turkey time (UTC+3) == 22:00 UTC
    - cron: "0 22 * * *"

permissions:
  contents: write

concurrency:
  group: daily-profile-automation
  cancel-in-progress: true

jobs:
  github_stats_svg:
    name: Update github_stats.svg
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Checkout generator repo
        uses: actions/checkout@v4
        with:
          repository: yogeshwaran01/github-stats-terminal-style
          path: _generator

      - name: Install generator deps
        working-directory: _generator
        run: npm ci

      - name: Patch theme colors (sentry red)
        working-directory: _generator
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          function findThemesFile(startDir) {
            const stack = [startDir];
            const candidates = new Set([
              'themes.json',
              'themes.ts',
              'themes.js',
              'themes.config.ts',
              'themes.config.js'
            ]);
            while (stack.length) {
              const dir = stack.pop();
              let entries;
              try {
                entries = fs.readdirSync(dir, { withFileTypes: true });
              } catch {
                continue;
              }
              for (const entry of entries) {
                const fullPath = path.join(dir, entry.name);
                if (entry.isFile() && candidates.has(entry.name)) return fullPath;
                if (entry.isDirectory() && !entry.name.startsWith('.')) stack.push(fullPath);
              }
            }
            return null;
          }

          const themesPath = findThemesFile('src') || findThemesFile('.');
          if (!themesPath || !fs.existsSync(themesPath)) throw new Error('themes file not found');

          if (themesPath.endsWith('.json')) {
            const themes = JSON.parse(fs.readFileSync(themesPath, 'utf8'));
            if (!themes.powershell) throw new Error('themes.json missing powershell theme');
            themes.powershell.back = '#200009';
            themes.powershell.username = '#88001b';
            fs.writeFileSync(themesPath, JSON.stringify(themes, null, 4) + '\n');
          } else {
            let text = fs.readFileSync(themesPath, 'utf8');
            const blockRegex = /(powershell\s*:\s*\{[\s\S]*?\})/;
            const match = text.match(blockRegex);
            if (!match) throw new Error(`themes file missing powershell theme: ${themesPath}`);
            let block = match[1];
            block = block
              .replace(/(background\s*:\s*['"])([^'"]*)(['"])/, '$1#200009$3')
              .replace(/(foreground\s*:\s*['"])([^'"]*)(['"])/, '$1#e6e6e6$3')
              .replace(/(cursor\s*:\s*['"])([^'"]*)(['"])/, '$1#88001b$3')
              .replace(/(["']0["']\s*:\s*['"])([^'"]*)(['"])/, '$1#200009$3')
              .replace(/(["']1["']\s*:\s*['"])([^'"]*)(['"])/, '$1#88001b$3')
              .replace(/(["']9["']\s*:\s*['"])([^'"]*)(['"])/, '$1#88001b$3');
            text = text.replace(blockRegex, block);
            fs.writeFileSync(themesPath, text);
          }
          console.log(`Patched powershell theme in ${themesPath}`);
          NODE

      - name: Generate stats svg
        working-directory: _generator
        env:
          # PAT secret used by the generator
          GHT: ${{ secrets.GHT }}
        run: |
          if [ ! -f "dist/bin/github-stats-terminal.js" ]; then
            npm run build
          fi
          node dist/bin/github-stats-terminal.js "${{ github.repository_owner }}" powershell

      - name: Copy svg into repo
        run: cp _generator/github_stats.svg ./github_stats.svg

      - name: Patch stats lines (repos/public/commits + neon prompt)
        env:
          GITHUB_TOKEN: ${{ secrets.GHT }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
          TOTAL_REPOS: "46"
        run: |
          python scripts/update_github_stats_svg.py

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add github_stats.svg

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: update github stats svg"
          for i in 1 2 3; do
            git pull --rebase origin main
            if git push origin HEAD:main; then
              exit 0
            fi
            echo "Push failed (attempt $i), retrying..."
            sleep 3
          done
          echo "Failed to push after retries."
          exit 1

  profile_views_total:
    name: Update profile_views_total.json
    runs-on: ubuntu-latest
    needs: github_stats_svg
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Generate total profile views endpoint
        run: python scripts/update_profile_views_total.py

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/profile_views_total.json
          if git diff --staged --quiet; then
            echo "No changes."
            exit 0
          fi
          git commit -m "chore: update total profile views"
          for i in 1 2 3; do
            git pull --rebase origin main
            if git push origin HEAD:main; then
              exit 0
            fi
            echo "Push failed (attempt $i), retrying..."
            sleep 3
          done
          echo "Failed to push after retries."
          exit 1

  sentrybot_views:
    name: Update sentrybot_views.json
    runs-on: ubuntu-latest
    needs: profile_views_total
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Generate SentryBOT repo views endpoint
        env:
          SENTRYBOT_TOKEN: ${{ secrets.SENTRYBOT_TOKEN }}
        run: python scripts/update_sentrybot_views.py
        continue-on-error: true

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/sentrybot_views.json
          if git diff --staged --quiet; then
            echo "No changes."
            exit 0
          fi
          git commit -m "chore: update SentryBOT views"
          for i in 1 2 3; do
            git pull --rebase origin main
            if git push origin HEAD:main; then
              exit 0
            fi
            echo "Push failed (attempt $i), retrying..."
            sleep 3
          done
          echo "Failed to push after retries."
          exit 1

  snake:
    name: Generate commit snake
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate snake (dark)
        uses: Platane/snk@v3
        with:
          github_user_name: WhoIsMrSentry
          outputs: |
            dist/snake_dark.svg?palette=github-dark&color_snake=#39ff14&color_dots=#88001b

      - name: Generate snake (light)
        uses: Platane/snk@v3
        with:
          github_user_name: WhoIsMrSentry
          outputs: |
            dist/snake.svg?palette=github-light&color_snake=#39ff14&color_dots=#88001b

      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
