name: Update Spotify Sections

on:
  schedule:
    - cron: "*/30 * * * *" # every 30 minutes
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run README updater
        # NOTE: Define the following repository secrets before enabling this workflow:
        # SPOTIFY_CLIENT_ID, SPOTIFY_CLIENT_SECRET, SPOTIFY_REFRESH_TOKEN, SPOTIFY_USER_ID
        # Optional: SPOTIFY_IGNORE_ARTISTS (JSON array), e.g. ["Artist A", "Artist B"]
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
          SPOTIFY_USER_ID: ${{ secrets.SPOTIFY_USER_ID }}
          README_PATH: README.md
        run: |
          python scripts/spotify_readme.py

      - name: Build top tracks JSON for carousel
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: |
          python scripts/spotify_top_json.py

      - name: Commit changes (README + docs)
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add README.md docs/spotify_top.json docs/index.html
          git commit -m "chore(spotify): auto-update README sections" || echo "no changes"
          git push
