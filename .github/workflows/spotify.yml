name: Update Spotify Sections

concurrency:
  group: spotify-update-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: "*/30 * * * *" # every 30 minutes
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run README updater
        # NOTE: Define the following repository secrets before enabling this workflow:
        # SPOTIFY_CLIENT_ID, SPOTIFY_CLIENT_SECRET, SPOTIFY_REFRESH_TOKEN, SPOTIFY_USER_ID
        # Optional: SPOTIFY_IGNORE_ARTISTS (JSON array), e.g. ["Artist A", "Artist B"]
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
          SPOTIFY_USER_ID: ${{ secrets.SPOTIFY_USER_ID }}
          README_PATH: README.md
        run: |
          python scripts/spotify_readme.py

      - name: Commit and push changes safely
        shell: bash
        run: |
          set -e
          git config user.name github-actions
          git config user.email actions@github.com
          git add README.md
          if git diff --cached --quiet; then
            echo "no changes"
            exit 0
          fi
          git commit -m "chore(spotify): auto-update README sections"
          # Rebase on latest remote to avoid non-fast-forward
          git pull --rebase origin "${GITHUB_REF_NAME}" || git pull --rebase || true
          # Retry push a couple of times in case of race
          for i in 1 2 3; do
            if git push; then
              echo "push ok"
              break
            fi
            echo "push failed, retrying ($i)"; sleep 2
            git pull --rebase origin "${GITHUB_REF_NAME}" || git pull --rebase || true
          done
